<Project ToolsVersion="4.0" DefaultTargets="Build" xmlns="http://schemas.microsoft.com/developer/msbuild/2003">

  <UsingTask TaskName="UpdateAssemblyVersion" TaskFactory="CodeTaskFactory" AssemblyFile="$(MSBuildToolsPath)\Microsoft.Build.Tasks.v4.0.dll">
    <ParameterGroup>
      <Version ParameterType="System.String" Required="true" />
      <Revision ParameterType="System.String" Required="true" />
      <Branch ParameterType="System.String" Required="true" />
      <AssemblyTemplateFile ParameterType="System.String" Required="true" />
      <AssemblyVersionFile ParameterType="System.String" Required="true" />
    </ParameterGroup>
    <Task>
      <Using Namespace="System" />
      <Using Namespace="System.Globalization" />
      <Using Namespace="System.IO" />
      <Using Namespace="Microsoft.Build.Framework" />
      <Using Namespace="Microsoft.Build.Utilities" />
      <Code Type="Fragment" Language="cs">
        <![CDATA[
try {
  // Mise à jour des informations d'assemblée.
  string template = File.ReadAllText(AssemblyTemplateFile)
      .Replace("$Branch$", Branch)
      .Replace("$BuildTime$", DateTime.Now.ToString("yyyy-MM-dd HH:mm"))
      .Replace("$Revision$", Revision)
      .Replace("$Version$", Version);
  File.WriteAllText(AssemblyVersionFile, template);
}
catch (IOException ex) {
    Log.LogErrorFromException(ex);
}

return !Log.HasLoggedErrors;
        ]]>
      </Code>
    </Task>
  </UsingTask>
</Project>