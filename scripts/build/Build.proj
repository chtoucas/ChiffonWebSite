<?xml version="1.0" encoding="utf-8" ?>
<!--
  TODO:
  On ne veut pas mettre à jour la version de compilation si rien n'a changé. En plus,
  cela empêcherait la compilation incrémentale. Il faut donc deviser un processus plus
  intelligent pour savoir quand on doit mettre à jour le numéro de "Build".
  Cf. http://stackoverflow.com/questions/11667510/determine-if-msbuild-corecompile-will-run-and-call-custom-target

  WARNING:
  L'ordre des directives est extrèmement important. Par exemple, "GetSemVer"
  doit absolument être exécuté après "UpdateVersionNumber". En effet, si une directive dépend
  indirectement de "GetSemVer" et si "UpdateVersionNumber" est lancé après, la valeur de "_SemVer"
  devient obsolète.
 -->

<Project ToolsVersion="4.0" DefaultTargets="Build"
         xmlns="http://schemas.microsoft.com/developer/msbuild/2003">
  <Import Project=".\Chiffon.common.targets" />
  <Import Project=".\Chiffon.tests.targets" />

  <PropertyGroup>
    <MvcBuildViews Condition="'$(MvcBuildViews)' != 'false'">true</MvcBuildViews>
  </PropertyGroup>

  <PropertyGroup>
    <BuildProperties>
      $(BuildProperties);
      MvcBuildViews=$(MvcBuildViews)
    </BuildProperties>
  </PropertyGroup>

  <ItemGroup>
    <ProjectsToBuild Include="$(_SourceDir)Chiffon.WebSite\assets\Chiffon.Assets.proj" />
    <ProjectsToBuild Include="$(_RootDir)Chiffon.sln">
      <AdditionalProperties>$(BuildProperties)</AdditionalProperties>
    </ProjectsToBuild>
  </ItemGroup>

  <Target Name="Clean" DependsOnTargets="DeleteTempBuildFiles">
    <MSBuild Projects="@(ProjectsToBuild)" Targets="Clean" />
  </Target>

  <Target Name="Build">
    <MSBuild Projects="@(ProjectsToBuild)" Targets="Build" StopOnFirstFailure="true">
      <Output ItemName="_BuildOutputs" TaskParameter="TargetOutputs" />
    </MSBuild>
  </Target>
  <Target Name="BeforeBuild" BeforeTargets="Build"
          DependsOnTargets="EmitProjectSolution;RestorePackages" />
  <Target Name="AfterBuild" AfterTargets="Build" DependsOnTargets="$(AfterBuildDependsOnTarget)" />

  <Target Name="Rebuild" DependsOnTargets="Clean;Build" />

  <ItemGroup>
    <_AfterBuildTargets Include="VerifyBuildOutputs" Condition="'$(Analyze)' == 'true'" />
    <_AfterBuildTargets Include="RunXunitTests" Condition="'$(RunTests)' == 'true'" />
  </ItemGroup>

  <PropertyGroup>
    <AfterBuildDependsOnTarget>@(_AfterBuildTargets)</AfterBuildDependsOnTarget>
  </PropertyGroup>

</Project>
